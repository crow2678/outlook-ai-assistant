<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Outlook AI Assistant</title>
    
    <!-- Office.js API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    
    <!-- Modern CSS Framework -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 15px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        h1 {
            color: #2d3748;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #718096;
            font-size: 14px;
        }

        .suggestion-tools {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .tool-btn {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 15px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-height: 80px;
        }

        .tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(66, 153, 225, 0.3);
        }

        .tool-btn:active {
            transform: translateY(0);
        }

        .tool-btn.formal {
            background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
        }

        .tool-btn.casual {
            background: linear-gradient(135deg, #38b2ac 0%, #319795 100%);
        }

        .tool-btn.shorter {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .tool-btn i {
            font-size: 18px;
        }

        .custom-section {
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #4a5568;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        textarea, input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .generate-btn {
            width: 100%;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(72, 187, 120, 0.3);
        }

        .generate-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* NEW: Progressive Disclosure Styles */
        .result-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(237, 242, 247, 0.5);
            border-radius: 12px;
            border-left: 4px solid #4299e1;
            display: none;
        }

        .result-section.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .email-component {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .component-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: rgba(66, 153, 225, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .component-header:hover {
            background: rgba(66, 153, 225, 0.15);
        }

        .component-header.expanded {
            background: rgba(66, 153, 225, 0.2);
        }

        .component-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            color: #2d3748;
            font-size: 14px;
        }

        .component-title i {
            color: #4299e1;
            font-size: 16px;
        }

        .expand-icon {
            color: #718096;
            transition: transform 0.3s ease;
            font-size: 12px;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
        }

        .component-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .component-content.expanded {
            max-height: 500px;
        }

        .component-inner {
            padding: 15px;
        }

        .component-text {
            color: #4a5568;
            line-height: 1.5;
            margin-bottom: 15px;
            font-size: 14px;
            white-space: pre-wrap;
        }

        /* Primary body component - always expanded */
        .email-component.primary {
            border-left: 4px solid #4299e1;
        }

        .email-component.primary .component-content {
            max-height: none;
            overflow: visible;
        }

        .email-component.primary .component-header {
            background: rgba(66, 153, 225, 0.2);
            cursor: default;
        }

        .email-component.primary .expand-icon {
            display: none;
        }

        /* Secondary components - collapsible */
        .email-component.secondary {
            border-left: 4px solid #e2e8f0;
        }

        .component-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .action-btn {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-btn:hover {
            border-color: #4299e1;
            background: #f7fafc;
        }

        .action-btn.insert {
            background: #4299e1;
            color: white;
            border-color: #4299e1;
        }

        .action-btn.insert:hover {
            background: #3182ce;
        }

        .action-btn.positive:hover {
            background: #c6f6d5;
            border-color: #48bb78;
        }

        .action-btn.negative:hover {
            background: #fed7d7;
            border-color: #f56565;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #718096;
            font-style: italic;
            padding: 30px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #4299e1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status {
            text-align: center;
            margin-top: 20px;
            color: #718096;
            font-size: 12px;
        }

        /* Onboarding Styles (preserved from original) */
        .onboarding-screen {
            text-align: center;
            padding: 20px;
        }

        .welcome-content {
            margin-top: 20px;
        }

        .feature-list {
            margin: 30px 0;
            text-align: left;
        }

        .feature-item {
            display: flex;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .feature-item i {
            font-size: 24px;
            margin-right: 15px;
            color: #4299e1;
            min-width: 40px;
        }

        .feature-item div h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: #2d3748;
        }

        .feature-item div p {
            margin: 0;
            font-size: 14px;
            color: #718096;
        }

        .next-btn {
            width: 100%;
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .next-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(66, 153, 225, 0.3);
        }

        .next-btn.secondary {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
        }

        .privacy-note {
            font-size: 12px;
            color: #718096;
            margin-top: 20px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .privacy-note i {
            margin-right: 8px;
            color: #48bb78;
        }

        .permission-content {
            margin-top: 20px;
        }

        .permission-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: left;
        }

        .permission-card h3 {
            margin: 10px 0;
            color: #2d3748;
        }

        .permission-card ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .permission-card li {
            margin: 8px 0;
            color: #4a5568;
        }

        .security-info {
            display: flex;
            align-items: flex-start;
            background: rgba(72, 187, 120, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .security-info i {
            font-size: 20px;
            color: #48bb78;
            margin-right: 15px;
            margin-top: 2px;
        }

        .security-info h4 {
            margin: 0 0 8px 0;
            color: #2d3748;
        }

        .security-info p {
            margin: 0;
            font-size: 13px;
            color: #4a5568;
            line-height: 1.4;
        }

        .button-group {
            margin-top: 30px;
        }

        .analysis-progress {
            margin: 40px 0;
        }

        .progress-circle {
            position: relative;
            margin: 30px auto;
            text-align: center;
        }

        .spinner-large {
            width: 80px;
            height: 80px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .progress-text {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .progress-text span {
            color: #4a5568;
        }

        .analysis-steps {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
        }

        .step {
            text-align: center;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .step.active {
            opacity: 1;
            color: #4299e1;
        }

        .step i {
            display: block;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .step span {
            font-size: 12px;
        }

        .calibration-content {
            margin-top: 20px;
        }

        .style-summary {
            background: rgba(66, 153, 225, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .style-summary h3 {
            margin: 0 0 15px 0;
            color: #2d3748;
        }

        .style-traits {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .trait {
            background: #4299e1;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .test-scenario {
            text-align: left;
            margin: 30px 0;
        }

        .test-scenario h4 {
            margin: 0 0 15px 0;
            color: #2d3748;
        }

        .original-text {
            background: rgba(237, 242, 247, 0.7);
            padding: 15px;
            border-radius: 8px;
            font-style: italic;
            margin: 15px 0;
            border-left: 3px solid #4299e1;
        }

        .ai-suggestions {
            margin: 20px 0;
        }

        .suggestion-option {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .suggestion-option:hover {
            border-color: #4299e1;
        }

        .suggestion-option input[type="radio"] {
            margin-right: 10px;
        }

        .suggestion-option label {
            cursor: pointer;
            font-size: 14px;
            line-height: 1.4;
        }

        .completion {
            padding: 40px 20px;
        }

        .success-animation {
            margin: 20px 0 30px;
        }

        .success-animation i {
            font-size: 64px;
            color: #48bb78;
            animation: bounce 1s ease;
        }

        .completion h2 {
            color: #2d3748;
            margin: 0 0 15px 0;
        }

        .completion p {
            color: #718096;
            margin: 0 0 30px 0;
        }

        .completion-features {
            margin: 30px 0;
        }

        .completion-features .feature {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            color: #4a5568;
        }

        .completion-features .feature i {
            margin-right: 10px;
            color: #4299e1;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* Hide main interface during onboarding */
        .container.onboarding .suggestion-tools,
        .container.onboarding .custom-section,
        .container.onboarding .result-section,
        .container.onboarding .status {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <!-- Main Interface -->
        <div id="mainInterface">
            <div class="header">
                <div class="logo">
                    <i class="fas fa-brain"></i>
                </div>
    
    <script>
        // Backend API endpoint (preserved)
        const API_BASE_URL = 'https://outlook-ai-backend-djerd0cve5aba2aw.westus2-01.azurewebsites.net';
        
        // Global variables (preserved + new progressive disclosure state)
        let authToken = null;
        let isOfficeReady = false;
        let currentSuggestionData = null; // NEW: Store full suggestion response

        // Onboarding state management (preserved)
        let onboardingState = {
            isFirstTime: true,
            step: 0,
            emailsSampled: 0,
            profileCreated: false,
            analysisInProgress: false
        };

        // Authentication functions (preserved)
        async function getAuthToken() {
            if (authToken) {
                return authToken;
            }
            
            try {
                console.log('Attempting to register/login user...');
                
                const registerResponse = await fetch(`${API_BASE_URL}/api/users/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'demo@outlook.com',
                        password: 'demo123456',
                        name: 'Demo User'
                    })
                });
                
                if (registerResponse.ok) {
                    const data = await registerResponse.json();
                    authToken = data.token;
                    console.log('Registration successful');
                    return authToken;
                }
                
                // If registration fails, try login
                const loginResponse = await fetch(`${API_BASE_URL}/api/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'demo@outlook.com',
                        password: 'demo123456'
                    })
                });
                
                if (loginResponse.ok) {
                    const loginData = await loginResponse.json();
                    authToken = loginData.token;
                    console.log('Login successful');
                    return authToken;
                }
                
                // If both fail, try auth endpoints with multiple admin credentials
                const adminCredentials = [
                    { email: 'admin@outlook.com', password: 'admin123456' },
                    { email: 'admin@admin.com', password: 'admin123' },
                    { email: 'test@admin.com', password: 'admin123' },
                    { email: 'admin@example.com', password: 'password123' },
                    { email: 'demo@outlook.com', password: 'demo123456' }
                ];

                for (const creds of adminCredentials) {
                    try {
                        console.log(`Trying login with: ${creds.email}`);
                        const authLoginResponse = await fetch(`${API_BASE_URL}/api/auth/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(creds)
                        });
                        
                        if (authLoginResponse.ok) {
                            const authData = await authLoginResponse.json();
                            console.log(`Success with ${creds.email}:`, authData);
                            authToken = authData.token || authData.accessToken || authData.jwt;
                            console.log('Auth login successful, token:', authToken);
                            return authToken;
                        } else {
                            console.log(`Failed with ${creds.email}: ${authLoginResponse.status}`);
                        }
                    } catch (error) {
                        console.log(`Error with ${creds.email}:`, error.message);
                    }
                }
                
                console.error('All authentication methods failed');
                return null;
                
            } catch (error) {
                console.error('Authentication error:', error);
                return null;
            }
        }

        // Office.js integration functions (preserved)
        async function getCurrentEmailContent() {
            return new Promise((resolve) => {
                if (!isOfficeReady || typeof Office === 'undefined') {
                    resolve('');
                    return;
                }
                
                try {
                    if (Office.context && Office.context.mailbox && Office.context.mailbox.item) {
                        Office.context.mailbox.item.body.getAsync(Office.CoercionType.Text, (result) => {
                            if (result.status === Office.AsyncResultStatus.Succeeded) {
                                resolve(result.value);
                            } else {
                                resolve('');
                            }
                        });
                    } else {
                        resolve('');
                    }
                } catch (error) {
                    console.log('Error getting email content:', error);
                    resolve('');
                }
            });
        }

        // NEW: Enhanced insertion functions for progressive disclosure
        function insertComponent(componentType) {
            let contentToInsert = '';
            
            switch(componentType) {
                case 'subject':
                    contentToInsert = document.getElementById('subjectText').textContent;
                    insertIntoSubjectLine(contentToInsert);
                    break;
                case 'body':
                    contentToInsert = document.getElementById('bodyText').textContent;
                    insertIntoEmailBody(contentToInsert);
                    break;
                case 'signature':
                    contentToInsert = document.getElementById('signatureText').textContent;
                    insertIntoEmailBody(contentToInsert); // Signatures go into body
                    break;
                default:
                    console.error('Unknown component type:', componentType);
                    return;
            }
            
            document.getElementById('status').textContent = `${componentType.charAt(0).toUpperCase() + componentType.slice(1)} inserted successfully`;
            setTimeout(() => {
                document.getElementById('status').textContent = 'Ready to assist with your email writing';
            }, 3000);
        }

        function insertIntoSubjectLine(content) {
            if (!isOfficeReady || typeof Office === 'undefined') {
                navigator.clipboard.writeText(content).then(() => {
                    document.getElementById('status').textContent = 'Subject copied to clipboard';
                }).catch(() => {
                    document.getElementById('status').textContent = 'Could not copy subject';
                });
                return;
            }
            
            try {
                if (Office.context && Office.context.mailbox && Office.context.mailbox.item) {
                    Office.context.mailbox.item.subject.setAsync(content, (result) => {
                        if (result.status === Office.AsyncResultStatus.Succeeded) {
                            document.getElementById('status').textContent = 'Subject inserted successfully';
                        } else {
                            navigator.clipboard.writeText(content);
                            document.getElementById('status').textContent = 'Subject copied to clipboard';
                        }
                    });
                } else {
                    navigator.clipboard.writeText(content);
                    document.getElementById('status').textContent = 'Subject copied to clipboard';
                }
            } catch (error) {
                navigator.clipboard.writeText(content);
                document.getElementById('status').textContent = 'Subject copied to clipboard';
            }
        }

        function insertIntoEmailBody(content) {
            if (!isOfficeReady || typeof Office === 'undefined') {
                navigator.clipboard.writeText(content).then(() => {
                    document.getElementById('status').textContent = 'Content copied to clipboard';
                }).catch(() => {
                    document.getElementById('status').textContent = 'Could not copy content';
                });
                return;
            }
            
            try {
                if (Office.context && Office.context.mailbox && Office.context.mailbox.item) {
                    Office.context.mailbox.item.body.setSelectedDataAsync(
                        content,
                        { coercionType: Office.CoercionType.Text },
                        (result) => {
                            if (result.status === Office.AsyncResultStatus.Succeeded) {
                                document.getElementById('status').textContent = 'Content inserted into email';
                            } else {
                                navigator.clipboard.writeText(content);
                                document.getElementById('status').textContent = 'Content copied to clipboard';
                            }
                        }
                    );
                } else {
                    navigator.clipboard.writeText(content);
                    document.getElementById('status').textContent = 'Content copied to clipboard';
                }
            } catch (error) {
                navigator.clipboard.writeText(content);
                document.getElementById('status').textContent = 'Content copied to clipboard';
            }
        }

        // Legacy insert function (preserved for backward compatibility)
        function insertSuggestion() {
            const bodyText = document.getElementById('bodyText');
            if (bodyText && bodyText.textContent) {
                insertComponent('body');
            } else {
                // Fallback to old behavior
                const suggestion = document.getElementById('suggestionText')?.textContent || '';
                insertIntoEmailBody(suggestion);
            }
        }

        // NEW: Progressive disclosure toggle functionality
        function toggleComponent(componentType) {
            const content = document.getElementById(`${componentType}Content`);
            const icon = document.getElementById(`${componentType}ExpandIcon`);
            const header = content.parentElement.querySelector('.component-header');
            
            if (content.classList.contains('expanded')) {
                // Collapse
                content.classList.remove('expanded');
                icon.classList.remove('expanded');
                header.classList.remove('expanded');
            } else {
                // Expand
                content.classList.add('expanded');
                icon.classList.add('expanded');
                header.classList.add('expanded');
            }
        }

        // AI suggestion functions (enhanced for progressive disclosure)
        async function quickSuggest(type) {
            console.log(`ðŸ”˜ ${type} button clicked`);
            
            const emailContext = document.getElementById('emailContext').value;
            console.log('Email content from textarea:', emailContext);
            
            if (!emailContext || emailContext.trim() === '') {
                document.getElementById('status').textContent = 'Please enter email content first';
                document.getElementById('status').style.color = 'red';
                setTimeout(() => {
                    document.getElementById('status').textContent = 'Ready to assist with your email writing';
                    document.getElementById('status').style.color = '';
                }, 3000);
                return;
            }
            
            // SALES-FOCUSED PROMPTS (preserved)
            const salesPrompts = {
                followup1: `Analyze this email and write a short, sharp first follow-up email for C-level executives. It must reference the original context, offer strategic value, and prompt a next step â€” all in under 100 words. Optimize for busy senior decision-makers: "${emailContext}"`,
                followup2: `Write a concise second follow-up email for C-level executives, assuming no reply to the first. It should feel professional, respectfully persistent, offer a new angle or value, and prompt action â€” under 100 words: "${emailContext}"`,
                proposal: `Transform this into a crisp, decision-ready business proposal email for C-level executives. Highlight strategic value, ROI impact, and clear next steps â€” structured so it can be read in under 1 minute: "${emailContext}"`,
                closing: `Rewrite this as a short, professional closing email with appropriate urgency (e.g. quarter-end). Create respectful FOMO, prompt action, and make it suitable for time-constrained C-level executives â€” under 100 words: "${emailContext}"`
            };
            
            console.log(`Using sales prompt for ${type}:`, salesPrompts[type]);
            await generateSuggestion(salesPrompts[type], emailContext);
        }
        
        async function generateCustom() {
            const customPrompt = document.getElementById('customPrompt').value;
            const emailContext = document.getElementById('emailContext').value;
            
            if (!customPrompt.trim()) {
                document.getElementById('status').textContent = 'Please enter a custom instruction';
                document.getElementById('status').style.color = 'red';
                setTimeout(() => {
                    document.getElementById('status').textContent = 'Ready to assist with your email writing';
                    document.getElementById('status').style.color = '';
                }, 3000);
                return;
            }

            const emailContent = emailContext || await getCurrentEmailContent();
            await generateSuggestion(customPrompt, emailContent);
        }

        // ENHANCED: Generate suggestion with progressive disclosure
        async function generateSuggestion(prompt, emailContent) {
            const resultSection = document.getElementById('resultSection');
            const loadingDiv = document.getElementById('loadingDiv');
            const suggestionResult = document.getElementById('suggestionResult');
            const generateBtn = document.getElementById('generateBtn');

            // Show loading
            resultSection.classList.add('show');
            loadingDiv.style.display = 'flex';
            suggestionResult.style.display = 'none';
            generateBtn.disabled = true;

            try {
                console.log('Getting authentication token...');
                const token = await getAuthToken();
                
                if (!token) {
                    throw new Error('Could not get valid authentication token.');
                }

                const requestData = {
                    prompt: prompt,
                    content: emailContent || 'Please provide a professional email template.',
                    context: {
                        recipientCount: 1,
                        emailType: 'general',
                        subject: '',
                        threadHistory: []
                    },
                    triggerType: getTypeFromPrompt(prompt),
                    preferences: {
                        tone: 'professional',
                        length: 'medium'
                    }
                };

                console.log('Sending authenticated request...');
                console.log('Request data:', requestData);

                const response = await fetch(`${API_BASE_URL}/api/ai/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(requestData)
                });

                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error response:', errorText);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('Success response:', data);
                
                // Store full response for component feedback
                currentSuggestionData = data;
                
                // NEW: Parse and display components using progressive disclosure
                parseAndDisplaySuggestion(data.suggestion || data.message || 'AI suggestion generated successfully');
                
                loadingDiv.style.display = 'none';
                suggestionResult.style.display = 'block';

            } catch (error) {
                console.error('Error generating suggestion:', error);
                loadingDiv.style.display = 'none';
                suggestionResult.style.display = 'block';
                
                // Show error in body component
                document.getElementById('bodyText').textContent = `Error: ${error.message}`;
                document.getElementById('bodyComponent').style.display = 'block';
            } finally {
                generateBtn.disabled = false;
            }
        }

        // NEW: Parse suggestion into components and display using progressive disclosure
        function parseAndDisplaySuggestion(suggestionText) {
            console.log('Parsing suggestion:', suggestionText);
            
            // Initialize components visibility
            document.getElementById('subjectComponent').style.display = 'none';
            document.getElementById('signatureComponent').style.display = 'none';
            document.getElementById('bodyComponent').style.display = 'block';
            
            // Try to parse structured response
            const components = parseEmailComponents(suggestionText);
            
            // Display body (always visible)
            document.getElementById('bodyText').textContent = components.body;
            
            // Display subject if available
            if (components.subject) {
                document.getElementById('subjectText').textContent = components.subject;
                document.getElementById('subjectComponent').style.display = 'block';
            }
            
            // Display signature if available
            if (components.signature) {
                document.getElementById('signatureText').textContent = components.signature;
                document.getElementById('signatureComponent').style.display = 'block';
            }
        }

        // NEW: Parse email components from suggestion text
        function parseEmailComponents(text) {
            const components = {
                subject: '',
                body: '',
                signature: ''
            };
            
            // Try to identify subject line
            const subjectMatch = text.match(/subject:\s*(.+?)(?:\n|$)/i) || 
                                text.match(/^subject:\s*(.+?)$/im) ||
                                text.match(/\*\*subject:\*\*\s*(.+?)(?:\n|$)/i);
            
            if (subjectMatch) {
                components.subject = subjectMatch[1].trim().replace(/['"]/g, '');
                text = text.replace(subjectMatch[0], '').trim();
            }
            
            // Try to identify signature
            const signaturePatterns = [
                /(?:best regards?|sincerely|regards?|thanks?|cheers),?\s*\n(.+?)$/is,
                /(?:\n|^)([^\n]*(?:regards?|sincerely|thanks?|cheers)[^\n]*)$/i,
                /signature:\s*(.+?)$/is
            ];
            
            for (const pattern of signaturePatterns) {
                const signatureMatch = text.match(pattern);
                if (signatureMatch) {
                    components.signature = signatureMatch[1].trim();
                    text = text.replace(signatureMatch[0], '').trim();
                    break;
                }
            }
            
            // Everything else is body
            components.body = text.trim() || 'AI suggestion generated successfully';
            
            console.log('Parsed components:', components);
            return components;
        }

        function getTypeFromPrompt(prompt) {
            const lowerPrompt = prompt.toLowerCase();
            
            if (lowerPrompt.includes('first follow-up') || lowerPrompt.includes('1st follow-up')) return 'followup1';
            if (lowerPrompt.includes('second follow-up') || lowerPrompt.includes('2nd follow-up')) return 'followup2';
            if (lowerPrompt.includes('follow-up') || lowerPrompt.includes('followup')) return 'followup1';
            if (lowerPrompt.includes('proposal') || lowerPrompt.includes('business proposal')) return 'proposal';
            if (lowerPrompt.includes('closing') || lowerPrompt.includes('urgency') || lowerPrompt.includes('urgent')) return 'closing';
            if (lowerPrompt.includes('formal')) return 'formal';
            if (lowerPrompt.includes('casual')) return 'casual';
            if (lowerPrompt.includes('shorter') || lowerPrompt.includes('concise')) return 'shorter';
            if (lowerPrompt.includes('longer') || lowerPrompt.includes('expand')) return 'longer';
            if (lowerPrompt.includes('improve') || lowerPrompt.includes('better')) return 'improve';
            
            return 'improve';
        }

        // NEW: Enhanced feedback functions for components
        async function sendComponentFeedback(componentType, isHelpful) {
            try {
                const token = await getAuthToken();
                if (!token) {
                    console.error('No auth token available');
                    return;
                }

                const componentText = document.getElementById(`${componentType}Text`).textContent;
                const suggestionId = window.currentSuggestionId || `feedback_${componentType}_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;
                
                console.log(`ðŸ“ Sending ${componentType} feedback:`, {
                    suggestionId: suggestionId,
                    isHelpful: isHelpful,
                    componentType: componentType
                });

                const feedbackPayload = {
                    suggestionId: suggestionId,
                    userAction: isHelpful ? 'accept' : 'reject',
                    rating: isHelpful ? 5 : 2,
                    comment: `${isHelpful ? 'Helpful' : 'Not helpful'} ${componentType} suggestion`,
                    componentType: componentType // Additional context
                };

                const response = await fetch(`${API_BASE_URL}/api/ai/feedback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(feedbackPayload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ Feedback error response:', errorText);
                    throw new Error(`Feedback failed: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                console.log('âœ… Feedback success:', result);

                document.getElementById('status').textContent = 
                    isHelpful ? `Thank you for the positive feedback on ${componentType}!` : `Thank you for the feedback on ${componentType}!`;
                
                setTimeout(() => {
                    document.getElementById('status').textContent = 'Ready to assist with your email writing';
                }, 3000);

            } catch (error) {
                console.error('ðŸ’¥ Error sending component feedback:', error);
                document.getElementById('status').textContent = `Failed to send ${componentType} feedback`;
                
                setTimeout(() => {
                    document.getElementById('status').textContent = 'Ready to assist with your email writing';
                }, 3000);
            }
        }

        // Legacy feedback function (preserved)
        async function sendFeedback(isHelpful) {
            // Route to body component feedback for backward compatibility
            await sendComponentFeedback('body', isHelpful);
        }

        // ONBOARDING FUNCTIONS (preserved with enhancements)
        
        // First-time user detection and onboarding initialization
        async function checkFirstTimeUser() {
            try {
                const token = await getAuthToken();
                if (!token) {
                    console.log('No auth token, assuming first time user');
                    startOnboarding();
                    return;
                }

                // Try to get user profile to check onboarding status
                const response = await fetch(`${API_BASE_URL}/api/users/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const profile = await response.json();
                    onboardingState.isFirstTime = !profile.onboardingComplete;
                    onboardingState.profileCreated = !!profile.writingStyle;
                    
                    if (onboardingState.isFirstTime) {
                        console.log('First time user detected, starting onboarding');
                        startOnboarding();
                    } else {
                        console.log('Returning user, showing main interface');
                        showMainInterface();
                    }
                } else {
                    console.log('Profile check failed, assuming first time user');
                    startOnboarding();
                }
            } catch (error) {
                console.log('Profile check error, assuming first time user:', error);
                startOnboarding();
            }
        }

        // Onboarding flow functions
        function startOnboarding() {
            console.log('Starting onboarding process');
            document.getElementById('mainInterface').style.display = 'none';
            document.getElementById('onboardingInterface').style.display = 'block';
            document.getElementById('mainContainer').classList.add('onboarding');
            showOnboardingStep(1);
        }

        function showOnboardingStep(step) {
            console.log('Showing onboarding step:', step);
            
            // Hide all screens first
            const screens = ['welcomeScreen', 'permissionScreen', 'analysisScreen', 'calibrationScreen', 'completionScreen', 'skipScreen'];
            screens.forEach(screenId => {
                const screen = document.getElementById(screenId);
                if (screen) screen.style.display = 'none';
            });
            
            // Show the appropriate screen
            switch(step) {
                case 1:
                    const welcomeScreen = document.getElementById('welcomeScreen');
                    if (welcomeScreen) welcomeScreen.style.display = 'block';
                    break;
                case 2:
                    const permissionScreen = document.getElementById('permissionScreen');
                    if (permissionScreen) permissionScreen.style.display = 'block';
                    break;
                case 3:
                    const analysisScreen = document.getElementById('analysisScreen');
                    if (analysisScreen) analysisScreen.style.display = 'block';
                    startEmailAnalysis();
                    break;
                case 4:
                    const calibrationScreen = document.getElementById('calibrationScreen');
                    if (calibrationScreen) calibrationScreen.style.display = 'block';
                    break;
                case 5:
                    const completionScreen = document.getElementById('completionScreen');
                    if (completionScreen) completionScreen.style.display = 'block';
                    break;
            }
            
            onboardingState.step = step;
        }

        function skipAnalysis() {
            console.log('User chose to skip analysis');
            const permissionScreen = document.getElementById('permissionScreen');
            const skipScreen = document.getElementById('skipScreen');
            if (permissionScreen) permissionScreen.style.display = 'none';
            if (skipScreen) skipScreen.style.display = 'block';
        }

        async function startEmailAnalysis() {
            console.log('Starting email analysis simulation');
            onboardingState.analysisInProgress = true;
            
            // Start progress animation
            updateAnalysisProgress();
            
            try {
                // Simulate email collection and analysis
                const emailSamples = await collectEmailSamples();
                
                // Send to backend for analysis
                const token = await getAuthToken();
                if (token) {
                    const response = await fetch(`${API_BASE_URL}/api/users/analyze-style`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            emailSamples: emailSamples,
                            analysisType: 'onboarding'
                        })
                    });
                    
                    if (response.ok) {
                        const analysis = await response.json();
                        console.log('Style analysis completed:', analysis);
                        onboardingState.profileCreated = true;
                    }
                }
                
                // Proceed to calibration after analysis
                setTimeout(() => {
                    onboardingState.analysisInProgress = false;
                    showOnboardingStep(4);
                }, 3000); // Allow time for progress animation
                
            } catch (error) {
                console.error('Email analysis failed:', error);
                // Still proceed to calibration even if analysis fails
                setTimeout(() => {
                    onboardingState.analysisInProgress = false;
                    showOnboardingStep(4);
                }, 2000);
            }
        }

        function updateAnalysisProgress() {
            const steps = [
                "Collecting recent emails...",
                "Analyzing tone patterns...",
                "Learning vocabulary preferences...",
                "Understanding relationship dynamics...",
                "Building your writing profile..."
            ];
            
            let currentStep = 0;
            const interval = setInterval(() => {
                if (currentStep < steps.length && onboardingState.analysisInProgress) {
                    const stepElement = document.getElementById('analysis-step');
                    const countElement = document.getElementById('analysis-count');
                    
                    if (stepElement) {
                        stepElement.textContent = steps[currentStep];
                    }
                    if (countElement) {
                        countElement.textContent = `${Math.min(currentStep * 4 + 4, 20)}/20`;
                    }
                    
                    // Update progress steps
                    updateProgressSteps(currentStep + 1);
                    
                    currentStep++;
                } else {
                    clearInterval(interval);
                }
            }, 800);
        }

        function updateProgressSteps(activeStep) {
            for (let i = 1; i <= 3; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (stepElement) {
                    if (i <= activeStep) {
                        stepElement.classList.add('active');
                    } else {
                        stepElement.classList.remove('active');
                    }
                }
            }
        }

        async function collectEmailSamples() {
            // In a real implementation, this would use Office.js to get recent sent emails
            // For now, return mock data for demo purposes
            console.log('Collecting email samples (simulated)');
            
            return [
                {
                    to: ["colleague@company.com"],
                    subject: "Project Update",
                    body: "Hi team, here's the latest update on our project. We're making good progress but I wanted to flag a few items that need attention.",
                    sent: new Date(),
                    relationship: "internal"
                },
                {
                    to: ["client@external.com"],
                    subject: "Meeting Follow-up",
                    body: "Thank you for taking the time to meet with us today. I wanted to follow up on the key points we discussed and outline our next steps.",
                    sent: new Date(),
                    relationship: "external"
                }
                // Add more mock samples as needed
            ];
        }

        async function saveStylePreference() {
            const selectedStyle = document.querySelector('input[name="style-pref"]:checked')?.value;
            console.log('Saving style preference:', selectedStyle);
            
            if (selectedStyle) {
                try {
                    const token = await getAuthToken();
                    if (token) {
                        await fetch(`${API_BASE_URL}/api/users/style-preference`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ preferredStyle: selectedStyle })
                        });
                    }
                } catch (error) {
                    console.error('Failed to save style preference:', error);
                }
            }
            
            showOnboardingStep(5);
        }

        async function finishOnboarding() {
            console.log('Finishing onboarding process');
            
            try {
                // Mark onboarding as complete
                const token = await getAuthToken();
                if (token) {
                    await fetch(`${API_BASE_URL}/api/users/complete-onboarding`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                }
            } catch (error) {
                console.error('Failed to mark onboarding complete:', error);
            }
            
            onboardingState.isFirstTime = false;
            showMainInterface();
        }

        function showMainInterface() {
            console.log('Showing main interface');
            const onboardingInterface = document.getElementById('onboardingInterface');
            const mainInterface = document.getElementById('mainInterface');
            const mainContainer = document.getElementById('mainContainer');
            
            if (onboardingInterface) onboardingInterface.style.display = 'none';
            if (mainInterface) mainInterface.style.display = 'block';
            if (mainContainer) mainContainer.classList.remove('onboarding');
            
            // Update status to show we're ready
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = isOfficeReady ? 'Connected to Outlook - Ready to assist!' : 'Ready to assist with your email writing';
            }
        }

        // INITIALIZATION FUNCTIONS

        // Modified initialization function to include onboarding check
        function initializeOffice() {
            if (typeof Office !== 'undefined') {
                Office.onReady((info) => {
                    isOfficeReady = true;
                    if (info.host === Office.HostType.Outlook) {
                        console.log('Office.js ready - Connected to Outlook');
                    } else {
                        console.log('Office.js ready - Not in Outlook environment');
                    }
                    
                    // Check if this is first time user and start onboarding
                    checkFirstTimeUser();
                });
            } else {
                console.log('Office.js not available - Running in standalone mode');
                // Start onboarding check even without Office.js
                checkFirstTimeUser();
            }
        }

        async function initializeAuth() {
            try {
                const token = await getAuthToken();
                if (token) {
                    console.log('Authentication successful');
                } else {
                    console.log('Authentication failed');
                }
            } catch (error) {
                console.error('Authentication initialization error:', error);
            }
        }

        // TESTING AND UTILITY FUNCTIONS

        // Test Azure OpenAI connection
        async function testAzureOpenAI() {
            try {
                console.log('Testing Azure OpenAI connection...');
                const token = await getAuthToken();
                
                const response = await fetch(`${API_BASE_URL}/api/test/azure-openai`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                
                const result = await response.text();
                console.log('Azure OpenAI Test Result:', response.status, result);
                
                if (response.ok) {
                    const statusElement = document.getElementById('status');
                    if (statusElement) statusElement.textContent = 'Azure OpenAI connection working!';
                } else {
                    const statusElement = document.getElementById('status');
                    if (statusElement) statusElement.textContent = 'Azure OpenAI connection failed - check console';
                }
                
                return response.ok;
            } catch (error) {
                console.error('Azure OpenAI test error:', error);
                const statusElement = document.getElementById('status');
                if (statusElement) statusElement.textContent = 'Azure OpenAI test failed - check console';
                return false;
            }
        }

        // NEW: Debug function to test progressive disclosure
        function debugProgressiveDisclosure() {
            console.log('ðŸ§ª Testing Progressive Disclosure');
            
            // Test parsing
            const mockSuggestion = `Subject: Follow-up on our discussion

Hi John,

I wanted to follow up on our meeting yesterday regarding the Q2 proposal. As discussed, I'm attaching the revised timeline that addresses your concerns about the delivery schedule.

Could we schedule a brief call this week to finalize the details?

Best regards,
Sarah Johnson
Senior Account Manager`;

            console.log('Mock suggestion:', mockSuggestion);
            
            // Test component parsing
            const components = parseEmailComponents(mockSuggestion);
            console.log('Parsed components:', components);
            
            // Display in UI
            parseAndDisplaySuggestion(mockSuggestion);
            
            // Show result section
            const resultSection = document.getElementById('resultSection');
            const loadingDiv = document.getElementById('loadingDiv');
            const suggestionResult = document.getElementById('suggestionResult');
            
            if (resultSection) resultSection.classList.add('show');
            if (loadingDiv) loadingDiv.style.display = 'none';
            if (suggestionResult) suggestionResult.style.display = 'block';
        }

        // NEW: Reset function for testing
        function resetInterface() {
            console.log('ðŸ”„ Resetting interface');
            
            // Clear all components
            const components = ['bodyText', 'subjectText', 'signatureText'];
            components.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = '';
            });
            
            // Hide result section
            const resultSection = document.getElementById('resultSection');
            if (resultSection) resultSection.classList.remove('show');
            
            // Collapse all secondary components
            const secondaryComponents = ['subject', 'signature'];
            secondaryComponents.forEach(type => {
                const content = document.getElementById(`${type}Content`);
                const icon = document.getElementById(`${type}ExpandIcon`);
                const header = content?.parentElement?.querySelector('.component-header');
                
                if (content) content.classList.remove('expanded');
                if (icon) icon.classList.remove('expanded');
                if (header) header.classList.remove('expanded');
            });
            
            // Reset status
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = 'Ready to assist with your email writing';
                statusElement.style.color = '';
            }
        }

        // NEW: Enhanced error handler with progressive disclosure support
        function handleError(error, context = 'general') {
            console.error(`Error in ${context}:`, error);
            
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = `Error: ${error.message || error}`;
                statusElement.style.color = 'red';
                
                setTimeout(() => {
                    statusElement.textContent = 'Ready to assist with your email writing';
                    statusElement.style.color = '';
                }, 5000);
            }
        }

        // NEW: Keyboard shortcuts for power users
        document.addEventListener('keydown', function(event) {
            // Ctrl/Cmd + Enter to generate suggestion
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                event.preventDefault();
                const customPrompt = document.getElementById('customPrompt');
                const emailContext = document.getElementById('emailContext');
                
                if (customPrompt && customPrompt.value.trim()) {
                    generateCustom();
                } else if (emailContext && emailContext.value.trim()) {
                    // Auto-generate improvement suggestion
                    quickSuggest('improve');
                }
            }
            
            // Escape key to collapse all components
            if (event.key === 'Escape') {
                const expandedComponents = document.querySelectorAll('.component-content.expanded');
                expandedComponents.forEach(component => {
                    const componentType = component.id.replace('Content', '');
                    if (componentType !== 'body') { // Don't collapse body
                        toggleComponent(componentType);
                    }
                });
            }
        });

        // Application startup sequence
        console.log('ðŸš€ Starting Outlook AI Assistant...');
        
        // Start initialization
        if (typeof Office !== 'undefined') {
            initializeOffice();
        } else {
            // Fallback initialization after delay
            setTimeout(initializeOffice, 1000);
        }

        // Initialize authentication in parallel
        initializeAuth();

        // Global error handler
        window.addEventListener('error', function(event) {
            handleError(event.error, 'global');
        });

        // Service worker registration (if available)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Could register service worker for offline functionality
                console.log('Service Worker support detected');
            });
        }

        console.log('âœ… Application initialization complete');
    </script>
</body>
</html>
                <h1>AI Assistant</h1>
                <p class="subtitle">Smart email writing companion</p>
            </div>

            <div class="suggestion-tools">
                <button class="tool-btn improve" onclick="quickSuggest('followup1')">
                    <i class="fas fa-reply"></i>
                    <span>1st Follow-up</span>
                </button>
                <button class="tool-btn formal" onclick="quickSuggest('followup2')">
                    <i class="fas fa-reply-all"></i>
                    <span>2nd Follow-up</span>
                </button>
                <button class="tool-btn casual" onclick="quickSuggest('proposal')">
                    <i class="fas fa-handshake"></i>
                    <span>Proposal</span>
                </button>
                <button class="tool-btn shorter" onclick="quickSuggest('closing')">
                    <i class="fas fa-clock"></i>
                    <span>Close/Urgent</span>
                </button>
            </div>

            <div class="custom-section">
                <div class="input-group">
                    <label for="customPrompt">Custom instruction:</label>
                    <input type="text" id="customPrompt" placeholder="e.g., Make it more professional, Add urgency...">
                </div>
                
                <div class="input-group">
                    <label for="emailContext">Email content (optional):</label>
                    <textarea id="emailContext" placeholder="Paste your draft email here for AI to improve..."></textarea>
                </div>

                <button class="generate-btn" onclick="generateCustom()" id="generateBtn">
                    <i class="fas fa-sparkles"></i> Generate Suggestion
                </button>
            </div>

            <!-- NEW: Progressive Disclosure Result Section -->
            <div class="result-section" id="resultSection">
                <div class="loading" id="loadingDiv">
                    <div class="spinner"></div>
                    <span>Generating suggestion...</span>
                </div>
                
                <div id="suggestionResult" style="display: none;">
                    <!-- Email Body Component (Primary - Always Visible) -->
                    <div class="email-component primary" id="bodyComponent">
                        <div class="component-header">
                            <div class="component-title">
                                <i class="fas fa-envelope-open-text"></i>
                                <span>Email Body</span>
                            </div>
                        </div>
                        <div class="component-content expanded">
                            <div class="component-inner">
                                <div class="component-text" id="bodyText"></div>
                                <div class="component-actions">
                                    <button class="action-btn insert" onclick="insertComponent('body')">
                                        <i class="fas fa-plus"></i> Insert Body
                                    </button>
                                    <button class="action-btn positive" onclick="sendComponentFeedback('body', true)">
                                        <i class="fas fa-thumbs-up"></i> Helpful
                                    </button>
                                    <button class="action-btn negative" onclick="sendComponentFeedback('body', false)">
                                        <i class="fas fa-thumbs-down"></i> Not helpful
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Subject Component (Secondary - Collapsible) -->
                    <div class="email-component secondary" id="subjectComponent" style="display: none;">
                        <div class="component-header" onclick="toggleComponent('subject')">
                            <div class="component-title">
                                <i class="fas fa-tag"></i>
                                <span>Subject Line</span>
                            </div>
                            <i class="fas fa-chevron-down expand-icon" id="subjectExpandIcon"></i>
                        </div>
                        <div class="component-content" id="subjectContent">
                            <div class="component-inner">
                                <div class="component-text" id="subjectText"></div>
                                <div class="component-actions">
                                    <button class="action-btn insert" onclick="insertComponent('subject')">
                                        <i class="fas fa-plus"></i> Insert Subject
                                    </button>
                                    <button class="action-btn positive" onclick="sendComponentFeedback('subject', true)">
                                        <i class="fas fa-thumbs-up"></i> Helpful
                                    </button>
                                    <button class="action-btn negative" onclick="sendComponentFeedback('subject', false)">
                                        <i class="fas fa-thumbs-down"></i> Not helpful
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Signature Component (Secondary - Collapsible) -->
                    <div class="email-component secondary" id="signatureComponent" style="display: none;">
                        <div class="component-header" onclick="toggleComponent('signature')">
                            <div class="component-title">
                                <i class="fas fa-signature"></i>
                                <span>Email Signature</span>
                            </div>
                            <i class="fas fa-chevron-down expand-icon" id="signatureExpandIcon"></i>
                        </div>
                        <div class="component-content" id="signatureContent">
                            <div class="component-inner">
                                <div class="component-text" id="signatureText"></div>
                                <div class="component-actions">
                                    <button class="action-btn insert" onclick="insertComponent('signature')">
                                        <i class="fas fa-plus"></i> Insert Signature
                                    </button>
                                    <button class="action-btn positive" onclick="sendComponentFeedback('signature', true)">
                                        <i class="fas fa-thumbs-up"></i> Helpful
                                    </button>
                                    <button class="action-btn negative" onclick="sendComponentFeedback('signature', false)">
                                        <i class="fas fa-thumbs-down"></i> Not helpful
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="status" id="status">
                Ready to assist with your email writing
            </div>
        </div>

        <!-- Onboarding Interface (Complete Structure) -->
        <div id="onboardingInterface" style="display: none;">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="onboarding-screen" style="display: none;">
                <div class="header">
                    <div class="logo">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h1>Welcome to AI Assistant!</h1>
                    <p class="subtitle">Your personal email writing companion</p>
                </div>
                
                <div class="welcome-content">
                    <div class="feature-list">
                        <div class="feature-item">
                            <i class="fas fa-magic"></i>
                            <div>
                                <h3>Smart Suggestions</h3>
                                <p>Get AI-powered writing improvements that match your style</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-user-cog"></i>
                            <div>
                                <h3>Personal Learning</h3>
                                <p>The AI learns your unique writing patterns and preferences</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-users"></i>
                            <div>
                                <h3>Context Aware</h3>
                                <p>Adapts tone based on who you're writing to</p>
                            </div>
                        </div>
                    </div>
                    
                    <button class="next-btn" onclick="showOnboardingStep(2)">
                        Get Started <i class="fas fa-arrow-right"></i>
                    </button>
                    
                    <div class="privacy-note">
                        <i class="fas fa-shield-alt"></i>
                        Your emails are processed securely and never stored permanently
                    </div>
                </div>
            </div>

            <!-- Permission Screen -->
            <div id="permissionScreen" class="onboarding-screen" style="display: none;">
                <div class="header">
                    <h2>Setup Your Personal AI</h2>
                    <p>To provide personalized suggestions, we need to analyze your writing style</p>
                </div>
                
                <div class="permission-content">
                    <div class="permission-card">
                        <i class="fas fa-envelope-open-text"></i>
                        <h3>Email Analysis</h3>
                        <p>We'll analyze 10-20 of your recent sent emails to understand:</p>
                        <ul>
                            <li>Your typical tone and formality level</li>
                            <li>Preferred vocabulary and phrases</li>
                            <li>Communication patterns with different contacts</li>
                            <li>Email structure preferences</li>
                        </ul>
                    </div>
                    
                    <div class="security-info">
                        <i class="fas fa-lock"></i>
                        <div>
                            <h4>Your Privacy is Protected</h4>
                            <p>â€¢ Emails are analyzed in real-time, not stored<br>
                            â€¢ Only writing patterns are saved, not content<br>
                            â€¢ All data is encrypted and user-specific</p>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="next-btn primary" onclick="showOnboardingStep(3)">
                            Allow Analysis <i class="fas fa-check"></i>
                        </button>
                        <button class="next-btn secondary" onclick="skipAnalysis()">
                            Skip (Use Basic Mode)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analysis Progress Screen -->
            <div id="analysisScreen" class="onboarding-screen" style="display: none;">
                <div class="header">
                    <h2>Analyzing Your Writing Style</h2>
                    <p>This will take just a moment...</p>
                </div>
                
                <div class="analysis-progress">
                    <div class="progress-circle">
                        <div class="spinner-large"></div>
                        <div class="progress-text">
                            <span id="analysis-step">Collecting emails...</span>
                            <span id="analysis-count">0/20</span>
                        </div>
                    </div>
                    
                    <div class="analysis-steps">
                        <div class="step active" id="step1">
                            <i class="fas fa-envelope"></i>
                            <span>Collecting samples</span>
                        </div>
                        <div class="step" id="step2">
                            <i class="fas fa-chart-line"></i>
                            <span>Analyzing patterns</span>
                        </div>
                        <div class="step" id="step3">
                            <i class="fas fa-user-cog"></i>
                            <span>Building profile</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Style Calibration Screen -->
            <div id="calibrationScreen" class="onboarding-screen" style="display: none;">
                <div class="header">
                    <h2>Great! Your Profile is Ready</h2>
                    <p>Let's test the AI with a few quick examples</p>
                </div>
                
                <div class="calibration-content">
                    <div class="style-summary">
                        <h3>Your Writing Style</h3>
                        <div class="style-traits">
                            <span class="trait">Professional</span>
                            <span class="trait">Concise</span>
                            <span class="trait">Friendly</span>
                        </div>
                    </div>
                    
                    <div class="test-scenario">
                        <h4>Test Scenario: Email to Your Manager</h4>
                        <div class="original-text">
                            "need to discuss project timeline issues"
                        </div>
                        
                        <div class="ai-suggestions">
                            <div class="suggestion-option">
                                <input type="radio" name="style-pref" id="option1" value="formal">
                                <label for="option1">
                                    "I would like to schedule a meeting to discuss some timeline concerns regarding our current project."
                                </label>
                            </div>
                            <div class="suggestion-option">
                                <input type="radio" name="style-pref" id="option2" value="balanced">
                                <label for="option2">
                                    "Hi [Manager], I'd like to discuss some timeline issues with the project. Could we schedule a quick chat?"
                                </label>
                            </div>
                            <div class="suggestion-option">
                                <input type="radio" name="style-pref" id="option3" value="direct">
                                <label for="option3">
                                    "Can we talk about the project timeline? I see some potential issues we should address."
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button class="next-btn" onclick="saveStylePreference()">
                        Save Preference & Continue
                    </button>
                </div>
            </div>

            <!-- Completion Screen -->
            <div id="completionScreen" class="onboarding-screen completion" style="display: none;">
                <div class="success-animation">
                    <i class="fas fa-check-circle"></i>
                </div>
                
                <h2>You're All Set!</h2>
                <p>Your AI Assistant is now personalized and ready to help</p>
                
                <div class="completion-features">
                    <div class="feature">
                        <i class="fas fa-bolt"></i>
                        <span>Try the Quick Actions above</span>
                    </div>
                    <div class="feature">
                        <i class="fas fa-comments"></i>
                        <span>Use Custom Instructions for specific needs</span>
                    </div>
                    <div class="feature">
                        <i class="fas fa-chart-line"></i>
                        <span>The AI gets better as you use it</span>
                    </div>
                </div>
                
                <button class="next-btn" onclick="finishOnboarding()">
                    Start Writing Better Emails!
                </button>
            </div>

            <!-- Skip Analysis Screen -->
            <div id="skipScreen" class="onboarding-screen" style="display: none;">
                <div class="header">
                    <h2>Basic Mode Enabled</h2>
                    <p>You can always enable personalized learning later in settings</p>
                </div>
                <button class="next-btn" onclick="finishOnboarding()">
                    Continue to AI Assistant
                </button>
            </div>
        </div>
    </div>