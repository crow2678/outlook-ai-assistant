<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Outlook AI Assistant</title>
    
    <!-- Office.js API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    
    <!-- Modern CSS Framework -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 15px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        h1 {
            color: #2d3748;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #718096;
            font-size: 14px;
        }

        .suggestion-tools {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .tool-btn {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 15px 12px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-height: 80px;
        }

        .tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(66, 153, 225, 0.3);
        }

        .tool-btn:active {
            transform: translateY(0);
        }

        .tool-btn.formal {
            background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
        }

        .tool-btn.casual {
            background: linear-gradient(135deg, #38b2ac 0%, #319795 100%);
        }

        .tool-btn.shorter {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
        }

        .tool-btn i {
            font-size: 18px;
        }

        .custom-section {
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #4a5568;
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        textarea, input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        textarea:focus, input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .generate-btn {
            width: 100%;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(72, 187, 120, 0.3);
        }

        .generate-btn:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .result-section {
            margin-top: 20px;
            padding: 20px;
            background: rgba(237, 242, 247, 0.5);
            border-radius: 12px;
            border-left: 4px solid #4299e1;
            display: none;
        }

        .result-section.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #718096;
            font-style: italic;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #4299e1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .feedback-section {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .feedback-btn {
            padding: 8px 15px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .feedback-btn.positive:hover {
            background: #c6f6d5;
            border-color: #48bb78;
        }

        .feedback-btn.negative:hover {
            background: #fed7d7;
            border-color: #f56565;
        }

        .status {
            text-align: center;
            margin-top: 20px;
            color: #718096;
            font-size: 12px;
        }

        /* NEW ONBOARDING STYLES */
        .onboarding-screen {
            text-align: center;
            padding: 20px;
        }

        .welcome-content {
            margin-top: 20px;
        }

        .feature-list {
            margin: 30px 0;
            text-align: left;
        }

        .feature-item {
            display: flex;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .feature-item i {
            font-size: 24px;
            margin-right: 15px;
            color: #4299e1;
            min-width: 40px;
        }

        .feature-item div h3 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: #2d3748;
        }

        .feature-item div p {
            margin: 0;
            font-size: 14px;
            color: #718096;
        }

        .next-btn {
            width: 100%;
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .next-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(66, 153, 225, 0.3);
        }

        .next-btn.secondary {
            background: linear-gradient(135deg, #a0aec0 0%, #718096 100%);
        }

        .privacy-note {
            font-size: 12px;
            color: #718096;
            margin-top: 20px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .privacy-note i {
            margin-right: 8px;
            color: #48bb78;
        }

        .permission-content {
            margin-top: 20px;
        }

        .permission-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            text-align: left;
        }

        .permission-card h3 {
            margin: 10px 0;
            color: #2d3748;
        }

        .permission-card ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .permission-card li {
            margin: 8px 0;
            color: #4a5568;
        }

        .security-info {
            display: flex;
            align-items: flex-start;
            background: rgba(72, 187, 120, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .security-info i {
            font-size: 20px;
            color: #48bb78;
            margin-right: 15px;
            margin-top: 2px;
        }

        .security-info h4 {
            margin: 0 0 8px 0;
            color: #2d3748;
        }

        .security-info p {
            margin: 0;
            font-size: 13px;
            color: #4a5568;
            line-height: 1.4;
        }

        .button-group {
            margin-top: 30px;
        }

        .analysis-progress {
            margin: 40px 0;
        }

        .progress-circle {
            position: relative;
            margin: 30px auto;
            text-align: center;
        }

        .spinner-large {
            width: 80px;
            height: 80px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .progress-text {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .progress-text span {
            color: #4a5568;
        }

        .analysis-steps {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
        }

        .step {
            text-align: center;
            opacity: 0.5;
            transition: opacity 0.3s ease;
        }

        .step.active {
            opacity: 1;
            color: #4299e1;
        }

        .step i {
            display: block;
            font-size: 20px;
            margin-bottom: 8px;
        }

        .step span {
            font-size: 12px;
        }

        .calibration-content {
            margin-top: 20px;
        }

        .style-summary {
            background: rgba(66, 153, 225, 0.1);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .style-summary h3 {
            margin: 0 0 15px 0;
            color: #2d3748;
        }

        .style-traits {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .trait {
            background: #4299e1;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .test-scenario {
            text-align: left;
            margin: 30px 0;
        }

        .test-scenario h4 {
            margin: 0 0 15px 0;
            color: #2d3748;
        }

        .original-text {
            background: rgba(237, 242, 247, 0.7);
            padding: 15px;
            border-radius: 8px;
            font-style: italic;
            margin: 15px 0;
            border-left: 3px solid #4299e1;
        }

        .ai-suggestions {
            margin: 20px 0;
        }

        .suggestion-option {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255,255,255,0.5);
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .suggestion-option:hover {
            border-color: #4299e1;
        }

        .suggestion-option input[type="radio"] {
            margin-right: 10px;
        }

        .suggestion-option label {
            cursor: pointer;
            font-size: 14px;
            line-height: 1.4;
        }

        .completion {
            padding: 40px 20px;
        }

        .success-animation {
            margin: 20px 0 30px;
        }

        .success-animation i {
            font-size: 64px;
            color: #48bb78;
            animation: bounce 1s ease;
        }

        .completion h2 {
            color: #2d3748;
            margin: 0 0 15px 0;
        }

        .completion p {
            color: #718096;
            margin: 0 0 30px 0;
        }

        .completion-features {
            margin: 30px 0;
        }

        .completion-features .feature {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            color: #4a5568;
        }

        .completion-features .feature i {
            margin-right: 10px;
            color: #4299e1;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* Hide main interface during onboarding */
        .container.onboarding .suggestion-tools,
        .container.onboarding .custom-section,
        .container.onboarding .result-section,
        .container.onboarding .status {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <!-- Main Interface (your existing structure) -->
        <div id="mainInterface">
            <div class="header">
                <div class="logo">
                    <i class="fas fa-brain"></i>
                </div>
                <h1>AI Assistant</h1>
                <p class="subtitle">Smart email writing companion</p>
            </div>

			<div class="suggestion-tools">
				<button class="tool-btn improve" onclick="quickSuggest('followup1')">
					<i class="fas fa-reply"></i>
					<span>1st Follow-up</span>
				</button>
				<button class="tool-btn formal" onclick="quickSuggest('followup2')">
					<i class="fas fa-reply-all"></i>
					<span>2nd Follow-up</span>
				</button>
				<button class="tool-btn casual" onclick="quickSuggest('proposal')">
					<i class="fas fa-handshake"></i>
					<span>Proposal</span>
				</button>
				<button class="tool-btn shorter" onclick="quickSuggest('closing')">
					<i class="fas fa-clock"></i>
					<span>Close/Urgent</span>
				</button>
			</div>

            <div class="custom-section">
                <div class="input-group">
                    <label for="customPrompt">Custom instruction:</label>
                    <input type="text" id="customPrompt" placeholder="e.g., Make it more professional, Add urgency...">
                </div>
                
                <div class="input-group">
                    <label for="emailContext">Email content (optional):</label>
                    <textarea id="emailContext" placeholder="Paste your draft email here for AI to improve..."></textarea>
                </div>

                <button class="generate-btn" onclick="generateCustom()" id="generateBtn">
                    <i class="fas fa-sparkles"></i> Generate Suggestion
                </button>
            </div>

            <div class="result-section" id="resultSection">
                <div class="loading" id="loadingDiv">
                    <div class="spinner"></div>
                    <span>Generating suggestion...</span>
                </div>
                <div id="suggestionResult" style="display: none;">
                    <h4>AI Suggestion:</h4>
                    <p id="suggestionText"></p>
                    <div class="feedback-section">
                        <button class="feedback-btn positive" onclick="sendFeedback(true)">
                            <i class="fas fa-thumbs-up"></i> Helpful
                        </button>
                        <button class="feedback-btn negative" onclick="sendFeedback(false)">
                            <i class="fas fa-thumbs-down"></i> Not helpful
                        </button>
                        <button class="feedback-btn" onclick="insertSuggestion()">
                            <i class="fas fa-plus"></i> Insert
                        </button>
                    </div>
                </div>
            </div>

            <div class="status" id="status">
                Ready to assist with your email writing
            </div>
        </div>

        <!-- Onboarding Interface (new addition) -->
        <div id="onboardingInterface" style="display: none;">
            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="onboarding-screen" style="display: none;">
                <div class="header">
                    <div class="logo">
                        <i class="fas fa-brain"></i>
                    </div>
                    <h1>Welcome to AI Assistant!</h1>
                    <p class="subtitle">Your personal email writing companion</p>
                </div>
                
                <div class="welcome-content">
                    <div class="feature-list">
                        <div class="feature-item">
                            <i class="fas fa-magic"></i>
                            <div>
                                <h3>Smart Suggestions</h3>
                                <p>Get AI-powered writing improvements that match your style</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-user-cog"></i>
                            <div>
                                <h3>Personal Learning</h3>
                                <p>The AI learns your unique writing patterns and preferences</p>
                            </div>
                        </div>
                        <div class="feature-item">
                            <i class="fas fa-users"></i>
                            <div>
                                <h3>Context Aware</h3>
                                <p>Adapts tone based on who you're writing to</p>
                            </div>
                        </div>
                    </div>
                    
                    <button class="next-btn" onclick="showOnboardingStep(2)">
                        Get Started <i class="fas fa-arrow-right"></i>
                    </button>
                    
                    <div class="privacy-note">
                        <i class="fas fa-shield-alt"></i>
                        Your emails are processed securely and never stored permanently
                    </div>
                </div>
            </div>

            <!-- Permission Screen -->
            <div id="permissionScreen" class="onboarding-screen" style="display: none;">
                <div class="header">
                    <h2>Setup Your Personal AI</h2>
                    <p>To provide personalized suggestions, we need to analyze your writing style</p>
                </div>
                
                <div class="permission-content">
                    <div class="permission-card">
                        <i class="fas fa-envelope-open-text"></i>
                        <h3>Email Analysis</h3>
                        <p>We'll analyze 10-20 of your recent sent emails to understand:</p>
                        <ul>
                            <li>Your typical tone and formality level</li>
                            <li>Preferred vocabulary and phrases</li>
                            <li>Communication patterns with different contacts</li>
                            <li>Email structure preferences</li>
                        </ul>
                    </div>
                    
                    <div class="security-info">
                        <i class="fas fa-lock"></i>
                        <div>
                            <h4>Your Privacy is Protected</h4>
                            <p>• Emails are analyzed in real-time, not stored<br>
                            • Only writing patterns are saved, not content<br>
                            • All data is encrypted and user-specific</p>
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button class="next-btn primary" onclick="showOnboardingStep(3)">
                            Allow Analysis <i class="fas fa-check"></i>
                        </button>
                        <button class="next-btn secondary" onclick="skipAnalysis()">
                            Skip (Use Basic Mode)
                        </button>
                    </div>
                </div>
            </div>

            <!-- Analysis Progress Screen -->
            <div id="analysisScreen" class="onboarding-screen" style="display: none;">
                <div class="header">
                    <h2>Analyzing Your Writing Style</h2>
                    <p>This will take just a moment...</p>
                </div>
                
                <div class="analysis-progress">
                    <div class="progress-circle">
                        <div class="spinner-large"></div>
                        <div class="progress-text">
                            <span id="analysis-step">Collecting emails...</span>
                            <span id="analysis-count">0/20</span>
                        </div>
                    </div>
                    
                    <div class="analysis-steps">
                        <div class="step active" id="step1">
                            <i class="fas fa-envelope"></i>
                            <span>Collecting samples</span>
                        </div>
                        <div class="step" id="step2">
                            <i class="fas fa-chart-line"></i>
                            <span>Analyzing patterns</span>
                        </div>
                        <div class="step" id="step3">
                            <i class="fas fa-user-cog"></i>
                            <span>Building profile</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Style Calibration Screen -->
            <div id="calibrationScreen" class="onboarding-screen" style="display: none;">
                <div class="header">
                    <h2>Great! Your Profile is Ready</h2>
                    <p>Let's test the AI with a few quick examples</p>
                </div>
                
                <div class="calibration-content">
                    <div class="style-summary">
                        <h3>Your Writing Style</h3>
                        <div class="style-traits">
                            <span class="trait">Professional</span>
                            <span class="trait">Concise</span>
                            <span class="trait">Friendly</span>
                        </div>
                    </div>
                    
                    <div class="test-scenario">
                        <h4>Test Scenario: Email to Your Manager</h4>
                        <div class="original-text">
                            "need to discuss project timeline issues"
                        </div>
                        
                        <div class="ai-suggestions">
                            <div class="suggestion-option">
                                <input type="radio" name="style-pref" id="option1" value="formal">
                                <label for="option1">
                                    "I would like to schedule a meeting to discuss some timeline concerns regarding our current project."
                                </label>
                            </div>
                            <div class="suggestion-option">
                                <input type="radio" name="style-pref" id="option2" value="balanced">
                                <label for="option2">
                                    "Hi [Manager], I'd like to discuss some timeline issues with the project. Could we schedule a quick chat?"
                                </label>
                            </div>
                            <div class="suggestion-option">
                                <input type="radio" name="style-pref" id="option3" value="direct">
                                <label for="option3">
                                    "Can we talk about the project timeline? I see some potential issues we should address."
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <button class="next-btn" onclick="saveStylePreference()">
                        Save Preference & Continue
                    </button>
                </div>
            </div>

            <!-- Completion Screen -->
            <div id="completionScreen" class="onboarding-screen completion" style="display: none;">
                <div class="success-animation">
                    <i class="fas fa-check-circle"></i>
                </div>
                
                <h2>You're All Set!</h2>
                <p>Your AI Assistant is now personalized and ready to help</p>
                
                <div class="completion-features">
                    <div class="feature">
                        <i class="fas fa-bolt"></i>
                        <span>Try the Quick Actions above</span>
                    </div>
                    <div class="feature">
                        <i class="fas fa-comments"></i>
                        <span>Use Custom Instructions for specific needs</span>
                    </div>
                    <div class="feature">
                        <i class="fas fa-chart-line"></i>
                        <span>The AI gets better as you use it</span>
                    </div>
                </div>
                
                <button class="next-btn" onclick="finishOnboarding()">
                    Start Writing Better Emails!
                </button>
            </div>

            <!-- Skip Analysis Screen -->
            <div id="skipScreen" class="onboarding-screen" style="display: none;">
                <div class="header">
                    <h2>Basic Mode Enabled</h2>
                    <p>You can always enable personalized learning later in settings</p>
                </div>
                <button class="next-btn" onclick="finishOnboarding()">
                    Continue to AI Assistant
                </button>
            </div>
        </div>
    </div>
	<script>
        // Backend API endpoint (your existing)
        const API_BASE_URL = 'https://outlook-ai-backend-djerd0cve5aba2aw.westus2-01.azurewebsites.net';
        
        // Global variables (your existing + new onboarding state)
        let authToken = null;
        let isOfficeReady = false;

        // NEW: Onboarding state management
        let onboardingState = {
            isFirstTime: true,
            step: 0,
            emailsSampled: 0,
            profileCreated: false,
            analysisInProgress: false
        };

        // Your existing authentication functions (preserved)
        async function getAuthToken() {
            if (authToken) {
                return authToken;
            }
            
            try {
                // First, try to register a user via the backend user endpoint
                console.log('Attempting to register/login user...');
                
                const registerResponse = await fetch(`${API_BASE_URL}/api/users/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'demo@outlook.com',
                        password: 'demo123456',
                        name: 'Demo User'
                    })
                });
                
                if (registerResponse.ok) {
                    const data = await registerResponse.json();
                    authToken = data.token;
                    console.log('Registration successful');
                    return authToken;
                }
                
                // If registration fails, try login
                const loginResponse = await fetch(`${API_BASE_URL}/api/users/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'demo@outlook.com',
                        password: 'demo123456'
                    })
                });
                
                if (loginResponse.ok) {
                    const loginData = await loginResponse.json();
                    authToken = loginData.token;
                    console.log('Login successful');
                    return authToken;
                }
                
                // If both fail, try auth endpoints with multiple admin credentials
                const adminCredentials = [
                    { email: 'admin@outlook.com', password: 'admin123456' },
                    { email: 'admin@admin.com', password: 'admin123' },
                    { email: 'test@admin.com', password: 'admin123' },
                    { email: 'admin@example.com', password: 'password123' },
                    { email: 'demo@outlook.com', password: 'demo123456' } // Keep demo as fallback
                ];

                for (const creds of adminCredentials) {
                    try {
                        console.log(`Trying login with: ${creds.email}`);
                        const authLoginResponse = await fetch(`${API_BASE_URL}/api/auth/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(creds)
                        });
                        
                        if (authLoginResponse.ok) {
                            const authData = await authLoginResponse.json();
                            console.log(`Success with ${creds.email}:`, authData);
                            authToken = authData.token || authData.accessToken || authData.jwt;
                            console.log('Auth login successful, token:', authToken);
                            return authToken;
                        } else {
                            console.log(`Failed with ${creds.email}: ${authLoginResponse.status}`);
                        }
                    } catch (error) {
                        console.log(`Error with ${creds.email}:`, error.message);
                    }
                }
                
                console.error('All authentication methods failed');
                return null;
                
            } catch (error) {
                console.error('Authentication error:', error);
                return null;
            }
        }

        // NEW: First-time user detection and onboarding initialization
        async function checkFirstTimeUser() {
            try {
                const token = await getAuthToken();
                if (!token) {
                    console.log('No auth token, assuming first time user');
                    startOnboarding();
                    return;
                }

                // Try to get user profile to check onboarding status
                const response = await fetch(`${API_BASE_URL}/api/users/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (response.ok) {
                    const profile = await response.json();
                    onboardingState.isFirstTime = !profile.onboardingComplete;
                    onboardingState.profileCreated = !!profile.writingStyle;
                    
                    if (onboardingState.isFirstTime) {
                        console.log('First time user detected, starting onboarding');
                        startOnboarding();
                    } else {
                        console.log('Returning user, showing main interface');
                        showMainInterface();
                    }
                } else {
                    console.log('Profile check failed, assuming first time user');
                    startOnboarding();
                }
            } catch (error) {
                console.log('Profile check error, assuming first time user:', error);
                startOnboarding();
            }
        }

        // NEW: Onboarding flow functions
        function startOnboarding() {
            console.log('Starting onboarding process');
            document.getElementById('mainInterface').style.display = 'none';
            document.getElementById('onboardingInterface').style.display = 'block';
            document.getElementById('mainContainer').classList.add('onboarding');
            showOnboardingStep(1);
        }

        function showOnboardingStep(step) {
            console.log('Showing onboarding step:', step);
            
            // Hide all screens first
            const screens = ['welcomeScreen', 'permissionScreen', 'analysisScreen', 'calibrationScreen', 'completionScreen', 'skipScreen'];
            screens.forEach(screenId => {
                document.getElementById(screenId).style.display = 'none';
            });
            
            // Show the appropriate screen
            switch(step) {
                case 1:
                    document.getElementById('welcomeScreen').style.display = 'block';
                    break;
                case 2:
                    document.getElementById('permissionScreen').style.display = 'block';
                    break;
                case 3:
                    document.getElementById('analysisScreen').style.display = 'block';
                    startEmailAnalysis();
                    break;
                case 4:
                    document.getElementById('calibrationScreen').style.display = 'block';
                    break;
                case 5:
                    document.getElementById('completionScreen').style.display = 'block';
                    break;
            }
            
            onboardingState.step = step;
        }

        function skipAnalysis() {
            console.log('User chose to skip analysis');
            document.getElementById('permissionScreen').style.display = 'none';
            document.getElementById('skipScreen').style.display = 'block';
        }

        async function startEmailAnalysis() {
            console.log('Starting email analysis simulation');
            onboardingState.analysisInProgress = true;
            
            // Start progress animation
            updateAnalysisProgress();
            
            try {
                // Simulate email collection and analysis
                const emailSamples = await collectEmailSamples();
                
                // Send to backend for analysis
                const token = await getAuthToken();
                if (token) {
                    const response = await fetch(`${API_BASE_URL}/api/users/analyze-style`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            emailSamples: emailSamples,
                            analysisType: 'onboarding'
                        })
                    });
                    
                    if (response.ok) {
                        const analysis = await response.json();
                        console.log('Style analysis completed:', analysis);
                        onboardingState.profileCreated = true;
                    }
                }
                
                // Proceed to calibration after analysis
                setTimeout(() => {
                    onboardingState.analysisInProgress = false;
                    showOnboardingStep(4);
                }, 3000); // Allow time for progress animation
                
            } catch (error) {
                console.error('Email analysis failed:', error);
                // Still proceed to calibration even if analysis fails
                setTimeout(() => {
                    onboardingState.analysisInProgress = false;
                    showOnboardingStep(4);
                }, 2000);
            }
        }

        function updateAnalysisProgress() {
            const steps = [
                "Collecting recent emails...",
                "Analyzing tone patterns...",
                "Learning vocabulary preferences...",
                "Understanding relationship dynamics...",
                "Building your writing profile..."
            ];
            
            let currentStep = 0;
            const interval = setInterval(() => {
                if (currentStep < steps.length && onboardingState.analysisInProgress) {
                    const stepElement = document.getElementById('analysis-step');
                    const countElement = document.getElementById('analysis-count');
                    
                    if (stepElement) {
                        stepElement.textContent = steps[currentStep];
                    }
                    if (countElement) {
                        countElement.textContent = `${Math.min(currentStep * 4 + 4, 20)}/20`;
                    }
                    
                    // Update progress steps
                    updateProgressSteps(currentStep + 1);
                    
                    currentStep++;
                } else {
                    clearInterval(interval);
                }
            }, 800);
        }

        function updateProgressSteps(activeStep) {
            for (let i = 1; i <= 3; i++) {
                const stepElement = document.getElementById(`step${i}`);
                if (stepElement) {
                    if (i <= activeStep) {
                        stepElement.classList.add('active');
                    } else {
                        stepElement.classList.remove('active');
                    }
                }
            }
        }

        async function collectEmailSamples() {
            // In a real implementation, this would use Office.js to get recent sent emails
            // For now, return mock data for demo purposes
            console.log('Collecting email samples (simulated)');
            
            return [
                {
                    to: ["colleague@company.com"],
                    subject: "Project Update",
                    body: "Hi team, here's the latest update on our project. We're making good progress but I wanted to flag a few items that need attention.",
                    sent: new Date(),
                    relationship: "internal"
                },
                {
                    to: ["client@external.com"],
                    subject: "Meeting Follow-up",
                    body: "Thank you for taking the time to meet with us today. I wanted to follow up on the key points we discussed and outline our next steps.",
                    sent: new Date(),
                    relationship: "external"
                }
                // Add more mock samples as needed
            ];
        }

        async function saveStylePreference() {
            const selectedStyle = document.querySelector('input[name="style-pref"]:checked')?.value;
            console.log('Saving style preference:', selectedStyle);
            
            if (selectedStyle) {
                try {
                    const token = await getAuthToken();
                    if (token) {
                        await fetch(`${API_BASE_URL}/api/users/style-preference`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ preferredStyle: selectedStyle })
                        });
                    }
                } catch (error) {
                    console.error('Failed to save style preference:', error);
                }
            }
            
            showOnboardingStep(5);
        }

        async function finishOnboarding() {
            console.log('Finishing onboarding process');
            
            try {
                // Mark onboarding as complete
                const token = await getAuthToken();
                if (token) {
                    await fetch(`${API_BASE_URL}/api/users/complete-onboarding`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                }
            } catch (error) {
                console.error('Failed to mark onboarding complete:', error);
            }
            
            onboardingState.isFirstTime = false;
            showMainInterface();
        }

        function showMainInterface() {
            console.log('Showing main interface');
            document.getElementById('onboardingInterface').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'block';
            document.getElementById('mainContainer').classList.remove('onboarding');
            
            // Update status to show we're ready
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = isOfficeReady ? 'Connected to Outlook - Ready to assist!' : 'Ready to assist with your email writing';
            }
        }

        // Your existing Office.js functions (preserved)
        async function getCurrentEmailContent() {
            return new Promise((resolve) => {
                if (!isOfficeReady || typeof Office === 'undefined') {
                    resolve('');
                    return;
                }
                
                try {
                    if (Office.context && Office.context.mailbox && Office.context.mailbox.item) {
                        Office.context.mailbox.item.body.getAsync(Office.CoercionType.Text, (result) => {
                            if (result.status === Office.AsyncResultStatus.Succeeded) {
                                resolve(result.value);
                            } else {
                                resolve('');
                            }
                        });
                    } else {
                        resolve('');
                    }
                } catch (error) {
                    console.log('Error getting email content:', error);
                    resolve('');
                }
            });
        }

        function insertSuggestion() {
            const suggestion = document.getElementById('suggestionText').textContent;
            
            if (!isOfficeReady || typeof Office === 'undefined') {
                navigator.clipboard.writeText(suggestion).then(() => {
                    document.getElementById('status').textContent = 'Suggestion copied to clipboard';
                }).catch(() => {
                    document.getElementById('status').textContent = 'Could not copy suggestion';
                });
                return;
            }
            
            try {
                if (Office.context && Office.context.mailbox && Office.context.mailbox.item) {
                    Office.context.mailbox.item.body.setSelectedDataAsync(
                        suggestion,
                        { coercionType: Office.CoercionType.Text },
                        (result) => {
                            if (result.status === Office.AsyncResultStatus.Succeeded) {
                                document.getElementById('status').textContent = 'Suggestion inserted into email';
                            } else {
                                navigator.clipboard.writeText(suggestion);
                                document.getElementById('status').textContent = 'Suggestion copied to clipboard';
                            }
                        }
                    );
                } else {
                    navigator.clipboard.writeText(suggestion).then(() => {
                        document.getElementById('status').textContent = 'Suggestion copied to clipboard';
                    });
                }
            } catch (error) {
                navigator.clipboard.writeText(suggestion).then(() => {
                    document.getElementById('status').textContent = 'Suggestion copied to clipboard';
                });
            }
        }

        // Your existing AI suggestion functions (preserved)
		async function quickSuggest(type) {
			console.log(`🔘 ${type} button clicked`);
			
			// Get email content from the textarea
			const emailContext = document.getElementById('emailContext').value;
			
			console.log('Email content from textarea:', emailContext);
			
			if (!emailContext || emailContext.trim() === '') {
				document.getElementById('status').textContent = 'Please enter email content first';
				document.getElementById('status').style.color = 'red';
				setTimeout(() => {
					document.getElementById('status').textContent = 'Ready to assist with your email writing';
					document.getElementById('status').style.color = '';
				}, 3000);
				return;
			}
			
			// SALES-FOCUSED PROMPTS
			const salesPrompts = {
				// Button 1: First Follow-up (Blue button)
				followup1: `Analyze this email and write a short, sharp first follow-up email for C-level executives. It must reference the original context, offer strategic value, and prompt a next step — all in under 100 words. Optimize for busy senior decision-makers: "${emailContext}"`,
				
				// Button 2: Second Follow-up (Purple button)  
				followup2: `Write a concise second follow-up email for C-level executives, assuming no reply to the first. It should feel professional, respectfully persistent, offer a new angle or value, and prompt action — under 100 words: "${emailContext}"`,
				
				// Button 3: Proposal/Pitch Email (Teal button)
				proposal: `Transform this into a crisp, decision-ready business proposal email for C-level executives. Highlight strategic value, ROI impact, and clear next steps — structured so it can be read in under 1 minute: "${emailContext}"`,
				
				// Button 4: Closing/Urgency Email (Orange button)
				closing: `Rewrite this as a short, professional closing email with appropriate urgency (e.g. quarter-end). Create respectful FOMO, prompt action, and make it suitable for time-constrained C-level executives — under 100 words: "${emailContext}"`
			};
			
			console.log(`Using sales prompt for ${type}:`, salesPrompts[type]);
			
			await generateSuggestion(salesPrompts[type], emailContext);
		}
		
        async function generateCustom() {
            const customPrompt = document.getElementById('customPrompt').value;
            const emailContext = document.getElementById('emailContext').value;
            
            if (!customPrompt.trim()) {
                document.getElementById('status').textContent = 'Please enter a custom instruction';
                document.getElementById('status').style.color = 'red';
                setTimeout(() => {
                    document.getElementById('status').textContent = 'Ready to assist with your email writing';
                    document.getElementById('status').style.color = '';
                }, 3000);
                return;
            }

            const emailContent = emailContext || await getCurrentEmailContent();
            await generateSuggestion(customPrompt, emailContent);
        }

// In your index.html, find the generateSuggestion function and update the endpoint URL

async function generateSuggestion(prompt, emailContent) {
    const resultSection = document.getElementById('resultSection');
    const loadingDiv = document.getElementById('loadingDiv');
    const suggestionResult = document.getElementById('suggestionResult');
    const suggestionText = document.getElementById('suggestionText');
    const generateBtn = document.getElementById('generateBtn');

    // Show loading
    resultSection.classList.add('show');
    loadingDiv.style.display = 'flex';
    suggestionResult.style.display = 'none';
    generateBtn.disabled = true;

    try {
        console.log('Getting authentication token...');
        const token = await getAuthToken();
        
        if (!token) {
            throw new Error('Could not get valid authentication token.');
        }

        // FIXED: Don't send userId in body - get it from JWT token on backend
        const requestData = {
            prompt: prompt,
            content: emailContent || 'Please provide a professional email template.',
            context: {
                recipientCount: 1,
                emailType: 'general',
                subject: '',
                threadHistory: []
            },
            triggerType: getTypeFromPrompt(prompt),
            preferences: {
                tone: 'professional',
                length: 'medium'
            }
            // ❌ REMOVED: userId: 'admin' - not needed!
        };

        console.log('Sending authenticated request...');
        console.log('Request data:', requestData);

        const response = await fetch(`${API_BASE_URL}/api/ai/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'Authorization': `Bearer ${token}` // Authentication is here!
            },
            body: JSON.stringify(requestData)
        });

        console.log('Response status:', response.status);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server error response:', errorText);
            throw new Error(`HTTP error! status: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        console.log('Success response:', data);
        
        loadingDiv.style.display = 'none';
        suggestionResult.style.display = 'block';
        suggestionText.textContent = data.suggestion || data.message || 'AI suggestion generated successfully';

    } catch (error) {
        console.error('Error generating suggestion:', error);
        loadingDiv.style.display = 'none';
        suggestionResult.style.display = 'block';
        suggestionText.textContent = `Error: ${error.message}`;
    } finally {
        generateBtn.disabled = false;
    }
}

// OPTION 2: Improve the getTypeFromPrompt function

function getTypeFromPrompt(prompt) {
    const lowerPrompt = prompt.toLowerCase();
    
    // Check for follow-up patterns first (more specific)
    if (lowerPrompt.includes('first follow-up') || lowerPrompt.includes('1st follow-up')) return 'followup1';
    if (lowerPrompt.includes('second follow-up') || lowerPrompt.includes('2nd follow-up')) return 'followup2';
    if (lowerPrompt.includes('follow-up') || lowerPrompt.includes('followup')) return 'followup1';
    
    // Check for other specific patterns
    if (lowerPrompt.includes('proposal') || lowerPrompt.includes('business proposal')) return 'proposal';
    if (lowerPrompt.includes('closing') || lowerPrompt.includes('urgency') || lowerPrompt.includes('urgent')) return 'closing';
    
    // Check for tone modifications
    if (lowerPrompt.includes('formal')) return 'formal';
    if (lowerPrompt.includes('casual')) return 'casual';
    if (lowerPrompt.includes('shorter') || lowerPrompt.includes('concise')) return 'shorter';
    if (lowerPrompt.includes('longer') || lowerPrompt.includes('expand')) return 'longer';
    
    // Check for improve last (so it doesn't override more specific patterns)
    if (lowerPrompt.includes('improve') || lowerPrompt.includes('better')) return 'improve';
    
    // Default fallback
    return 'improve';
}



// Also update any other API calls that might be using wrong endpoints:

// If you have any calls to these endpoints, update them:
// OLD: /api/generate -> NEW: /api/ai/generate
// OLD: /api/feedback -> NEW: /api/ai/feedback
// OLD: /api/stats -> NEW: /api/ai/stats

        async function sendFeedback(isHelpful) {
            try {
                const token = await getAuthToken();
                if (!token) return;

                const response = await fetch(`${API_BASE_URL}/api/ai/feedback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        feedback: isHelpful ? 'positive' : 'negative',
                        suggestion: document.getElementById('suggestionText').textContent
                    })
                });

                document.getElementById('status').textContent = 
                    isHelpful ? 'Thank you for the positive feedback!' : 'Thank you for the feedback!';
                
                setTimeout(() => {
                    document.getElementById('status').textContent = 'Ready to assist with your email writing';
                }, 3000);

            } catch (error) {
                console.error('Error sending feedback:', error);
            }
        }

        // Modified initialization function to include onboarding check
        function initializeOffice() {
            if (typeof Office !== 'undefined') {
                Office.onReady((info) => {
                    isOfficeReady = true;
                    if (info.host === Office.HostType.Outlook) {
                        console.log('Office.js ready - Connected to Outlook');
                    } else {
                        console.log('Office.js ready - Not in Outlook environment');
                    }
                    
                    // NEW: Check if this is first time user and start onboarding
                    checkFirstTimeUser();
                });
            } else {
                console.log('Office.js not available - Running in standalone mode');
                // NEW: Start onboarding check even without Office.js
                checkFirstTimeUser();
            }
        }

        async function initializeAuth() {
            try {
                const token = await getAuthToken();
                if (token) {
                    console.log('Authentication successful');
                } else {
                    console.log('Authentication failed');
                }
            } catch (error) {
                console.error('Authentication initialization error:', error);
            }
        }

        // Your existing test function (preserved)
        async function testAzureOpenAI() {
            try {
                console.log('Testing Azure OpenAI connection...');
                const token = await getAuthToken();
                
                const response = await fetch(`${API_BASE_URL}/api/test/azure-openai`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                
                const result = await response.text();
                console.log('Azure OpenAI Test Result:', response.status, result);
                
                if (response.ok) {
                    document.getElementById('status').textContent = 'Azure OpenAI connection working!';
                } else {
                    document.getElementById('status').textContent = 'Azure OpenAI connection failed - check console';
                }
                
                return response.ok;
            } catch (error) {
                console.error('Azure OpenAI test error:', error);
                document.getElementById('status').textContent = 'Azure OpenAI test failed - check console';
                return false;
            }
        }

        // Start initialization
        if (typeof Office !== 'undefined') {
            initializeOffice();
        } else {
            setTimeout(initializeOffice, 1000);
        }
    </script>
</body>
</html>